<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>Introduction to HK2 API</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      </head>
  <body class="composite">
    <!-- TODO: move this into JavaScript to patch the skin
      <div class="xright">  </div>
    -->
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Compatibility<a name="Compatibility"></a></h2><p>This page describes the HK2 2.0 API, which is based on JSR-330 standard annotations. Also, Habitat has been replaced with a new interface called <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>.</p></div><div class="section"><h2>Table of Contents<a name="Table_of_Contents"></a></h2><ul><li><a href="#Introduction">Introduction</a></li><li><a href="#ServiceLocator">ServiceLocator</a></li><li><a href="#Adding_in_your_own_services">Adding in your own services</a><ul><li><a href="#BuilderHelper_Binding_EDSL">BuilderHelper Binding EDSL</a></li><li><a href="#DescriptorImpl">DescriptorImpl</a></li><li><a href="#Binding_a_Descriptor_into_a_ServiceLocator">Binding a Descriptor into a ServiceLocator</a></li></ul></li><li><a href="#Looking_up_Services">Looking up Services</a><ul><li><a href="#Looking_up_services_by_name">Looking up services by name</a></li><li><a href="#Looking_up_services_with_qualifiers">Looking up services with qualifiers</a></li><li><a href="#Getting_all_services">Getting all services</a></li><li><a href="#Getting_service_descriptors">Getting service descriptors</a></li></ul></li><li><a href="#Unmanaged_Creation_Injection_and_Lifecycle">Unmanaged Creation, Injection and Lifecycle</a></li></ul></div><div class="section"><h2><a name="Introduction">Introduction</a></h2><p>HK2 is a declarative framework for services using annotations like <a href="./apidocs/org/jvnet/hk2/annotations/Contract.html">Contract</a> and <a href="./apidocs/org/jvnet/hk2/annotations/Service.html">Service</a>. However, it is possible to use programmatic APIs to precisely control the services and bindings available within the Services registry.</p><p>Find information about testing hk2 components <a href="./testing.html">here</a>.</p></div><div class="section"><h2><a name="ServiceLocator">ServiceLocator</a></h2><p>The most fundamental service in HK2 is the <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>. The <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> represents the registry where services are looked up and where information about services (known as <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptors</a>) are bound into the registry. The <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> itself is represented as a service in its own registry; it is always the first service bound into its own registry.</p><p><a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocators</a> are named uniquely in a JVM and each has a unique locator ID. It is possible to create or find <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocators</a> using the <a href="./apidocs/org/glassfish/hk2/api/ServiceLocatorFactory.html">ServiceLocatorFactory</a>. The <a href="./apidocs/org/glassfish/hk2/api/ServiceLocatorFactory.html">ServiceLocatorFactory</a> will normally use a default implementation of <a href="./apidocs/org/glassfish/hk2/extension/ServiceLocatorGenerator.html">ServiceLocatorGenerator</a> specified in META-INF/services. The default implementation can be changed by having a different META-INF/services specification of the implementation of <a href="./apidocs/org/glassfish/hk2/extension/ServiceLocatorGenerator.html">ServiceLocatorGenerator</a> earlier in the classpath than the provided implementation. An implementation of <a href="./apidocs/org/glassfish/extension/api/ServiceLocatorGenerator.html">ServiceLocatorGenerator</a> can also be given directly to the <a href="./apidocs/org/glassfish/hk2/api/ServiceLocatorFactory.html">ServiceLocatorFactory</a> create method.</p><p>Once you have created a <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> with the <a href="./apidocs/org/glassfish/hk2/api/ServiceLocatorFactory.html">ServiceLocatorFactory</a> it will contain three services:</p><ol style="list-style-type: decimal"><li>Itself (see <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>)</li><li>The default JSR-330 resolver (see <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">InjectionResolver</a>)</li><li>A service for configuring further services (see <a href="./apidocs/org/glassfish/hk2/api/DynamicConfigurationService.html">DynamicConfigurationService</a>)</li></ol></div><div class="section"><h2><a name="Adding_in_your_own_services">Adding in your own services</a></h2><p>While the three services in your <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> are nice, they hardly constitute a useful system. What is needed is all of your services, in order to make it useful. Also please note that this section assumes that you are not using the upper level system that automatically reads in the descriptions of your services and populate <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocators</a> for you. For information on how that system works see TBD.</p><p>You add your own service by getting the <a href="./apidocs/org/glassfish/hk2/api/DynamicConfigurationService.html">DynamicConfigurationService</a>. Since that is one of the original three services added to the service locator, you can get that service by simply looking it up:</p><div class="source"><pre>    public void initialize() {
        ServiceLocatorFactory factory = ServiceLocatorFactory.getInstance();
        
        ServiceLocator locator = factory.create(&quot;HelloWorld&quot;);
        
        DynamicConfigurationService dcs = locator.getService(DynamicConfigurationService.class);
        
        ...
    }</pre></div><p>You use the <a href="./apidocs/org/glassfish/hk2/api/DynamicConfigurationService.html">DynamicConfigurationService</a> to create <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a> instances. The <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a> interface has a few methods for binding in descriptions of your services.</p><p>In order to bind in services you need to first create a description of your service. A description of your service gives information about the service, such as the name of the implementation class, and the name of the classes or interfaces which the service should be available to be looked up as, and other information. In general, any implementation of <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> can be used, but we have provided at least two mechanisms for creating <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptors</a> that you might want to use. We will go through those mechanisms in the next two sections, and then come back to adding in your own descriptor to your newly created <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>.</p><div class="section"><h3><a name="BuilderHelper_Binding_EDSL">BuilderHelper Binding EDSL</a></h3><p>An EDSL is an Embedded Domain Specific Language that allows you to build up objects specific to your particular domain. In this case we provide an EDSL for building Descriptors.</p><p>Lets take an example. Suppose I wanted to tell the system about a service of mine that has implementation class com.acme.internal.WidgetImpl which implements the com.acme.Widget contract (interface) and which is in the PerLookup scope (which means a new instance of WidgetImpl will be provided for every injection point). Here is how a descriptor that contains all of that information can be built up using our EDSL:</p><div class="source"><pre>    public Descriptor createWidgetDescriptor() {
        return BuilderHelper.link(&quot;com.acme.internal.WidgetImpl&quot;).
                         to(&quot;com.acme.Widget&quot;).
                         in(&quot;org.glassfish.api.PerLookup&quot;).
                         build();
    }</pre></div><p>The <a href="./apidocs/org/glassfish/hk2/utilities/BuilderHelper.html">BuilderHelper</a> link method creates a <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorBuilder.html">DescriptorBuilder</a>. The <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorBuilder.html">DescriptorBuilder</a> then creates more and more specific versions of itself as you fill in the data with calls to &quot;to&quot; or &quot;in&quot; or &quot;qualifiedBy&quot;.</p><p>Finally, when you are finished filling in all the details of your service, you call build in order to produce a <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> that can be used in a bind call of <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a>.</p><p>It is interesting to note that the build call of <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorBuilder.html">DescriptorBuilder</a> produces a <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorImpl.html">DescriptorImpl</a>. A <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorImpl.html">DescriptorImpl</a> is nothing more than a convenience implementation of <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> that has settable fields. Hence, if your code wanted to use the EDSL to produce a basic <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> and then further customize it with the added methods of <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorImpl.html">DescriptorImpl</a> it could do so.</p></div><div class="section"><h3><a name="DescriptorImpl">DescriptorImpl</a></h3><p>Rather than create your own implementation of <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> we have provided an implementation of <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> called <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorImpl.html">DescriptorImpl</a>. This implementation has convenient methods for setting all of the fields of <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a>. It should be noted that the bind API of <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a> will make a deep copy of whatever <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> is passed to it, and that the underlying implementation of the HK2 API never uses the <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorImpl.html">DescriptorImpl</a> class directly. It is purely there as a convenience class for those who wish to provide their own <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptors</a>.</p><p>Here is an example that achieves the same <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> as the example in the previous section but uses the <a href="./apidocs/org/glassfish/hk2/utilities/DescriptorImpl.html">DescriptorImpl</a> to do it:</p><div class="source"><pre>    public Descriptor createWidgetDescriptor() {
        DescriptorImpl retVal = new DescriptorImpl();
        
        retVal.setImplementation(&quot;com.acme.internal.WidgetImpl&quot;);
        retVal.addAdvertisedContract(&quot;com.acme.internal.WidgetImpl&quot;);
        retVal.addAdvertisedContract(&quot;com.acme.Widget&quot;);
        retVal.setScope(&quot;org.glassfish.api.PerLookup&quot;);
        
        return retVal;
    }</pre></div><p>One interesting thing to notice in the above code is that we added the implementation class as an advertisedContract. This was done automatically for us in the <a href="./apidocs/org/glassfish/hk2/utilities/BuilderHelper.html">BuilderHelper</a> case, but needed to be explicitly done in this case.</p></div><div class="section"><h3><a name="Binding_a_Descriptor_into_a_ServiceLocator">Binding a Descriptor into a ServiceLocator</a></h3><p>Now that we have seen two simple ways to create a <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> lets take a look at how we bind that descriptor into our <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>. Here is an example:</p><div class="source"><pre>    public void initialize() {
        ServiceLocatorFactory factory = ServiceLocatorFactory.getInstance();
        
        ServiceLocator locator = factory.create(&quot;HelloWorld&quot;);
        
        DynamicConfigurationService dcs = locator.getService(DynamicConfigurationService.class);
        
        DynamicConfiguration config = dcs.createDynamicConfiguration();
        
        config.bind(createWidgetDescriptor());
        
        config.commit();
    }</pre></div><p>The method createWidgetDescriptor is from the preceeding examples. In the above code we call the createDynamicConfiguration method of <a href="./apidocs/org/glassfish/hk2/api/DynamicConfigurationService.html">DynamicConfigurationService</a>. This creates an instance of <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a>. To use a <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a> you call the bind or unbind methods until you are happy with the change and then you call commit to make the changes occur for real in the system. If you do not call commit none of the changes you added to the <a href="./apidocs/org/glassfish/hk2/api/DynamicConfiguration.html">DynamicConfiguration</a> instance will be made to the system.</p><p>That is all there is to it! The services you add in this manner can now be looked up or injected into other services or generally manipulated through all of the other methods in <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>.</p></div></div><div class="section"><h2><a name="Looking_up_Services">Looking up Services</a></h2><p>There are several mechanisms for looking up services in HK2. The simplest is to just call getService method of <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> with the class of the service you are interested in:</p><div class="source"><pre>  Widget widget = locator.getService(Widget.class);</pre></div><p>The type passed in can be any implementation class or interface with which the service was bound with as an advertisable contract. If there is no Widget that can be found in the system then the getService method will return null. If there are more than one Widge (e.g. Widget is an interface that can have many implementations) then the best Widget will be returned from the getService method.</p><p>The best instance of a service is a service with the highest ranking or the lowest service id. The ranking of a service is found in its <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> and can be changed at any time at run time. The service id of a service is a system assigned value for the <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> when it is bound into the <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>. The system assigned value is a monotonically increasing value. Thus if two services have the same ranking the best service will be associated with the oldest <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptor</a> bound into the system.</p><div class="section"><h3><a name="Looking_up_services_by_name">Looking up services by name</a></h3><p>Services can be qualified in many ways, but the most common is to have a name associated with the service. Hence, in our Widget example if there are several Widgets in the system but each has a different name we can find our particular Widget like this:</p><div class="source"><pre>    public Widget getNamedWidget(String name) {
        return locator.getService(Widget.class, name);
    }</pre></div><p>The given name is used to further qualify the specific Widget that was bound into the system.</p></div><div class="section"><h3><a name="Looking_up_services_with_qualifiers">Looking up services with qualifiers</a></h3><p>If your services have qualifiers you can look them up via the qualifiers. In order to do this you can use the <a href="./apidocs/org/glassfish/hk2/AnnotationLiteral.html">AnnotationLiteral</a> in order to create concrete implementations of your annotations. Lets see how this would be done. Suppose you have a qualifer called Blue, defined like this:</p><div class="source"><pre>@Qualifier
@Retention(RUNTIME)
@Target( { TYPE, METHOD, FIELD, PARAMETER })
public @interface Blue {
}</pre></div><p>Normally you wouldn't implement Blue, but in this case you do need an implementation in order to be able to look it up. You do that by providing an implement of Blue that extends <a href="./apidocs/org/glassfish/hk2/AnnotationLiteral.html">AnnotationLiteral</a>:</p><div class="source"><pre>public class BlueImpl extends AnnotationLiteral&lt;Blue&gt; implements Blue {
}</pre></div><p>You can now use this BlueImpl to look up your qualified Widget in a <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> like this:</p><div class="source"><pre>    Widget widget = locator.getService(Widget.class, new BlueImpl());</pre></div><p>This will get the Widget that has been qualified with @Blue.</p></div><div class="section"><h3><a name="Getting_all_services">Getting all services</a></h3><p>You may also want to get all of the services that have advertised a certain contract. You can do this like this:</p><div class="source"><pre>    List&lt;Widget&gt; widgetList = locator.getAllServices(Widget.class);</pre></div><p>The list returned will have as many Widgets that could be found in the system. It is important to note in this case that all of the Widges will have been classloaded when you use this call, so if classloading performance is important to you be careful of using the getAllServices method. Instead, consider using the getAllServiceHandles or getDescriptors method.</p></div><div class="section"><h3><a name="Getting_service_descriptors">Getting service descriptors</a></h3><p>If you want to look up service descriptors rather than the services themselves you can use the getDescriptor or getBestDescriptor methods on <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a>. The getDescriptor and getBestDescriptor methods will never cause classloading to occur, so it is safe to use in environments where classloading can be an issue.</p><p>The getDescriptor methods on <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> use a <a href="./apidocs/org/glassfish/hk2/api/Filter.html">Filter</a> to determine which <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptors</a> to return. You can implement your own <a href="./apidocs/org/glassfish/hk2/api/Filter.html">Filter</a> or you can use one of the <a href="./apidocs/org/glassfish/hk2/api/Filter.html">Filter</a> implementations provided by <a href="./apidocs/org/glassfish/hk2/utilities/BuilderHelper.html">BuilderHelper</a>. The most common case is to use an <a href="./apidocs/org/glassfish/hk2/api/IndexedFilter.html">IndexedFilter</a> provided by <a href="./apidocs/org/glassfish/hk2/utilities/BuilderHelper.html">BuilderHelper</a>, like this:</p><div class="source"><pre>  IndexedFilter widgetFilter = BuilderHelper.createContractFilter(Widget.class.getName());
  
  List&lt;ActiveDescriptor&lt;?&gt;&gt; widgetDescriptors = locator.getDescriptors(widgetFilter);</pre></div><p>Using an <a href="./apidocs/org/glassfish/hk2/api/IndexedFilter.html">IndexedFilter</a> can greatly improve the search time for your <a href="./apidocs/org/glassfish/hk2/api/Descriptor.html">Descriptors</a>.</p></div></div><div class="section"><h2><a name="Unmanaged_Creation_Injection_and_Lifecycle">Unmanaged Creation, Injection and Lifecycle</a></h2><p>There are times when you would like to have an object created, injected or have its lifecycle methods called by HK2, but not have that Object be explicitly managed by HK2. The <a href="./apidocs/org/glassfish/hk2/api/ServiceLocator.html">ServiceLocator</a> has methods that suit this case. These methods will inspect the class or object given and will attempt to perform the requested operations, without keeping track or managaging those objects in any way.</p><p>The first method is the create method, which will attempt to create an instance of the given class using the dependency injection rules of HK2:</p><div class="source"><pre>  Widget widget = locator.create(WidgetImpl.class);</pre></div><p>It is important to note that the only references to other beans that will have been initialized when this returns are those necessary to perform constructor injection. Hence any @Inject fields or @Inject initializer methods will NOT have been initialized when this method returns.</p><p>If you already have an object, and would like for its @Inject fields and @Inject initializer methods to get filled in, you can use the inject method:</p><div class="source"><pre>  locator.inject(widget);</pre></div><p>The object given will be analyzed and all of the fields and methods will be injected upon return. However, any postConstruct method on the object will not have been called yet. That can be done with the postConstruct method:</p><div class="source"><pre>  locator.postConstruct(widget);</pre></div><p>This method call will find the postConstruct method on widget and call it. Once the user is finished with the object, they can force the preDestroy to be called on it by using the preDestroy method:</p><div class="source"><pre>  locator.preDestroy(widget);</pre></div><p>This sequence can be very useful when there is some special processing that needs to happen and the user does not want to have HK2 manage the objects themselves.</p></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2012
    
          Oracle Corporation
          
  

  
  
  &nbsp;| Last Published: 04/25/2012
  &nbsp;| Version: 2.1.0-SNAPSHOT
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
