<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>Introduction to HK2 Run Level Services</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      </head>
  <body class="composite">
    <!-- TODO: move this into JavaScript to patch the skin
      <div class="xright">  </div>
    -->
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Purpose<a name="Purpose"></a></h2><p>This page describes run level services for HK2 2.0.</p></div><div class="section"><h2>Table of Contents<a name="Table_of_Contents"></a></h2><ul><li><a href="#Introduction">Introduction</a></li><li><a href="#Getting_Started">Getting Started</a><ul><li><a href="#Named_RunLevelController">Named RunLevelController</a></li><li><a href="#Validating_Run_Level_Services">Validating Run Level Services</a><ul><li><a href="#Constraint_Rules">Constraint Rules</a></li></ul></li><li><a href="#Non-Validating_Run_Level_Services">Non-Validating Run Level Services</a></li><li><a href="#Start_Order">Start Order</a></li><li><a href="#Stop_Order">Stop Order</a></li><li><a href="#Interrupt">Interrupt</a></li><li><a href="#The_Kernel_Run_Level">The Kernel Run Level</a></li></ul></li><li><a href="#Extensibility">Extensibility</a><ul><li><a href="#Sorter">Sorter</a></li><li><a href="#Activator">Activator</a></li><li><a href="#RunLevelListener">RunLevelListener</a></li></ul></li><li><a href="#Conclusion">Conclusion</a></li></ul></div><div class="section"><h2><a name="Introduction">Introduction</a></h2><p>HK2 run level services were designed to offer life cycle controller mechanisms. Life cycle involves the starting or stopping of a system in phases known as run levels.</p><p>HK2 normally employs a lazy instantiation model for component creation. However, there are situations where a developer may want the component to be created either immediately upon HK2 initialization or at some predetermined life cycle phase. This can be accomplished using the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation.</p><p>The run level services were also designed to support an arbitrary number of user defined run levels as well as run level subsystems, where the same life cycle controllers can be used with different sets of run levels that are meaningful for each subsystem.</p></div><div class="section"><h2><a name="Getting_Started">Getting Started</a></h2><p>In order to make a service a run level service, you annotate your service class with the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation.</p><div class="source"><pre>@RunLevel(1)
@Service
public class MyService implements MyContract {
...
}</pre></div><p>MyService is declared with a run level value of 1. The run level value must be an integer value.</p><p>In order to proceed through the various run levels, you need an instance of a <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a>.</p><p>The <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> is the controller responsible for automatically instantiating services annotated with <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a>. This is done using the proceedTo() method on the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> interface.</p><p>A default <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> implementation called <a href="./apidocs/org/glassfish/hk2/runlevel/utilities/RunLevelControllerImpl.html">RunLevelControllerImpl</a> is provided and registered as an HK2 service.</p><div class="source"><pre>@Inject
RunLevelController controller;

...

controller.proceedTo(1);</pre></div><p>Since MyService was declared to be in run level 1, it will be created when controller.proceedTo(1) is called.</p><p>It is also possible to interrogate the current and planned run levels of the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a>.</p><div class="source"><pre>Integer currentRunLevel = controller.getCurrentRunLevel();
Integer plannedRunLevel = controller.getPlannedRunLevel();</pre></div><div class="section"><h3><a name="Named_RunLevelController">Named RunLevelController</a></h3><p>You should use the <a class="externalLink" href="http://docs.oracle.com/javaee/6/api/javax/inject/Named.html">Named</a> annotation on each <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> to differentiate different run level controllers for different subsystems. This allows for run level scoping which is useful for modeling life cycle for subsystems which span more than a single service (e.g. EJB container, Logging subsystem, etc.).</p><p>The <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelControllerIndicator.html">RunLevelControllerIndicator</a> is a <a class="externalLink" href="http://docs.oracle.com/javaee/6/api/javax/inject/Qualifier.html">qualifier</a> that permits namespace groupings of run level services to occur. Use the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelControllerIndicator.html">RunLevelControllerIndicator</a> annotation to specify the name of the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> that will be associated with the service and control its activation. When not declared, association with the unnamed <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> is implied.</p><div class="source"><pre>@Service
@Named(&quot;myRLC&quot;)
public class MyRunLevelController implements RunLevelController {
...
}

...

@RunLevel(5)
@RunLevelControllerIndicator(&quot;myRLC&quot;)
@Service
public class MyService implements MyContract {
}

...

@Inject
@Named(&quot;myRLC&quot;)
RunLevelController myRLC;

public void start() {
  myRLC.proceedTo(5);
}</pre></div><p>The run level service MyService will be associated with (controlled by) the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> named &quot;myRLC&quot;.</p></div><div class="section"><h3><a name="Validating_Run_Level_Services">Validating Run Level Services</a></h3><p>By default, a run level service may only be active if the current run level value of its associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> is greater than or equal to the value specified in its <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation.</p><p>With validating run level services, a runtime check is performed when the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotated service is going to be activated. The check ensures that the run level services' associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> has reached the run level value specified in its <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation. If not, a <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelException.html"> RunLevelException</a> is thrown.</p><div class="source"><pre>@RunLevel(2)
@Service
public class MyService implements MyContract {
}

...

@Service
public class StandardService {
  @Inject
  MyService myService;
}</pre></div><p>Notice that the non run level service StandardService injects the run level service MyService, which is annotated with a run level value of 2. If an instance of StandardService is created when the associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController's</a> current run level is less than 2, the injection of MyService will fail with a <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelException.html"> RunLevelException</a>.</p><p>Also note that the mode of VALIDATING is the default for <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a>. It could be specified explicitly by setting mode = RunLevel.Mode.VALIDATING.</p><div class="source"><pre>@RunLevel(2, mode = RunLevel.Mode.VALIDATING)
@Service
public MyService implements MyContract {
}</pre></div><div class="section"><h4><a name="Constraint_Rules">Constraint Rules</a></h4><p>The following constraint rules apply to validating run level services :</p><ul><li>A <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotated service with a value N can not be injected with another <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotated service with a value M where M &gt; N.</li><li>When a <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotated service is injected into a non run level service, the injection will fail if the non run level service is activated prior to the associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> reaching the run level value specified in the run level services' <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation.</li></ul></div></div><div class="section"><h3><a name="Non-Validating_Run_Level_Services">Non-Validating Run Level Services</a></h3><p>There are cases where <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> is used simply to ensure that a service is activated no later than a given run level. In these cases, the mode of the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> should be set to NON_VALIDATING.</p><p>In the non validating mode, no run time check is done during run level service activation so a non validating run level service may be activated before its associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> reaches the run level specified in its <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation.</p><p>Non validating run level services will be activated (if not already) when the run level specified in the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation is achieved by the associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a>.</p><div class="source"><pre>@RunLevel(2, mode = RunLevel.Mode.NON_VALIDATING)
@Service
public MyService implements MyContract {
}

...

@Service
public class StandardService {
  @Inject
  MyService myService;
}</pre></div><p>The run level service MyService will be activated when the non run level service StandardService is activated, or when its associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> reaches run level value 2, whichever comes first.</p></div><div class="section"><h3><a name="Start_Order">Start Order</a></h3><p>When two services are found to have the same <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> value, they will be activated during the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController's</a> proceedTo() operation provided that the run level value on the service is less than or equal to the argument passed to proceedTo(). The <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> operates one run level value at a time.</p><div class="source"><pre>@RunLevel(1)
@Service
public class MyService1 implements MyContract {
}

@RunLevel(1)
@Service
public class MyService2 implements MyContract {
}

@RunLevel(2)
@Service
public class MyService3 implements MyContract {
}

@RunLevel(2)
@Service
public class MyService4 implements MyContract {
  @Inject
  MyService3 myService3;
}

...

@Inject
RunLevelController rlc1;

public void start() {
  rlc1.proceedTo(2);
}</pre></div><p>Assuming we start from run level value 0, a call to rlc1.proceedTo(2) will first activate MyService1 or MyService2. While both services will eventually be activated, it is non-deterministic which of the two will actually come first since they both are annotated with the same run level value of 1.</p><p>After all services annotated with the value of 1 are located from the HK2 service registry and activated, the system will proceed to run level value 2. This case is different in that the start order is deterministic, at least with respect to MyService3 and MyService4. MyService3 must be started before MyService4 because MyService4 depends on (i.e., injects) MyService3.</p></div><div class="section"><h3><a name="Stop_Order">Stop Order</a></h3><p>The <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> can also be used to shutdown/deactivate services that were previously activated.</p><div class="source"><pre>rlc1.proceedTo(0);</pre></div><p>Continuing from the previous example, a call to rlc1.proceedTo(0) will release all of the run level services that were activated with the call to rlc2.proceedTo(2). Note that shutdown will occur in the reverse order from the instantiation order. So the shutdown order will be MyService4, MyService3, (MyService1 | MyService2).</p></div><div class="section"><h3><a name="Interrupt">Interrupt</a></h3><p>In the event that a critical error is encountered during run level service activation and it is desirable for the operations of the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> to be aborted, then interrupt() could be called on the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> instance. The implementation should be thread safe so that interrupt() can be called from a listener or by some other monitoring thread.</p></div><div class="section"><h3><a name="The_Kernel_Run_Level">The Kernel Run Level</a></h3><p>The kernel run level has the value -1. It is considered special in that run level services annotated with it will be instantiated immediately upon HK2 startup.</p></div></div><div class="section"><h2><a name="Extensibility">Extensibility</a></h2><p>HK2 provides a default <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> implementation called <a href="./apidocs/org/glassfish/hk2/runlevel/utilities/RunLevelControllerImpl.html">RunLevelControllerImpl</a> which delegates part of its work to other services that it attempts locate in the HK2 service registry. These services include the <a href="./apidocs/org/glassfish/hk2/runlevel/Sorter.html">Sorter</a> and the <a href="./apidocs/org/glassfish/hk2/runlevel/Activator.html">Activator</a>.</p><p>In addition to delegating work to the <a href="./apidocs/org/glassfish/hk2/runlevel/Sorter.html">Sorter</a> and <a href="./apidocs/org/glassfish/hk2/runlevel/Activator.html">Activator</a>, the provided <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> implementation sends related run level events to all associated <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelListener.html">RunLevelListener(s)</a>.</p><p>Users may declare there own implementations of these services in order to extend the functionality of the provided <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> implementation.</p><p>Users are also free to write their own <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> implementation or extend the existing <a href="./apidocs/org/glassfish/hk2/runlevel/utilities/RunLevelControllerImpl.html">RunLevelControllerImpl</a>.</p><div class="section"><h3><a name="Activator">Activator</a></h3><p>The <a href="./apidocs/org/glassfish/hk2/runlevel/Activator.html">Activator</a> service can be optionally declared to override the default behavior of <a href="./apidocs/org/glassfish/hk2/runlevel/utilities/RunLevelControllerImpl.html">RunLevelControllerImpl</a> that delegates the actual activation and deactivation of the run level services.</p><div class="source"><pre>@Service
@RunLevelControllerIndicator(&quot;rlc1&quot;)
public static class MyActivator implements Activator { ... }</pre></div><p>MyActivator will be located by the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> named &quot;rlc1&quot; and used for activating and deactivating run level services.</p></div><div class="section"><h3><a name="Sorter">Sorter</a></h3><p>Callers can declare a service implementing the <a href="./apidocs/org/glassfish/hk2/runlevel/Sorter.html">Sorter</a> to override the default behavior of <a href="./apidocs/org/glassfish/hk2/runlevel/utilities/RunLevelControllerImpl.html">RunLevelControllerImpl</a> for sorting the run level services prior to activation.</p><p>Earlier it was suggested that the start order of services in the same run level is non-deterministic. This default behavior can be overridden by applying a custom <a href="./apidocs/org/glassfish/hk2/runlevel/Sorter.html">Sorter</a>.</p><div class="source"><pre>@Service
@RunLevelControllerIndicator(&quot;rlc1&quot;)
public static class MySorter implements Sorter { ... }</pre></div><p>MySorter will be located by the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> named &quot;rlc1&quot; and used for sorting run level services prior to activation.</p></div><div class="section"><h3><a name="RunLevelListener">RunLevelListener</a></h3><p>The set of <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelListener.html">RunLevelListeners</a> associated with the default RunLevelController will be notified of important events during it's operations. It is important to note that the default RunLevelController captures most Throwable types and sends them to the listeners - in general Exceptions are not emitted out to the caller of the default <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a>. The listeners are also notified of progress and cancellation events.</p><div class="source"><pre>@Service
@RunLevelControllerIndicator(&quot;rlc1&quot;)
public static class MyListener implements RunLevelListener { ... }</pre></div><p>MyListener will be located by the <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevelController.html">RunLevelController</a> named &quot;rlc1&quot; and will be notified of related run level service events.</p></div></div><div class="section"><h2><a name="Conclusion">Conclusion</a></h2><p>The <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation is appropriate when you need the system to automatically start your services. Typically, there is no need to add a <a href="./apidocs/org/glassfish/hk2/runlevel/RunLevel.html">RunLevel</a> annotation to most services because Hk2 will automatically start your service when it is needed (i.e., by injection).</p></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2013
    
          Oracle Corporation
          
  

  
  
  &nbsp;| Last Published: 01/22/2013
  &nbsp;| Version: 2.1.53-SNAPSHOT
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
